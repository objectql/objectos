# Base Layer 实现提案 - 决策文档

## 一、提案摘要

**提案**: 在 ObjectQL 中实现 Airtable 风格的 Base 层

**结论**: ⭐⭐⭐⭐⭐ **强烈推荐实施**

**方案**: 轻量级 Base 层（逻辑隔离方案）

**优先级**: P1 (高优先级)

**时间**: 2-3 周（3.5 人周）

**成本**: 低风险、高回报

---

## 二、问题陈述

### 2.1 当前架构问题

ObjectQL 当前的组织结构：

```
Organization (组织) 
  ├── App (界面)
  └── Object (数据表)
```

**存在的问题**：

1. **数据隔离不足**: 
   - 一个组织下所有项目的数据混在一起
   - 无法为单个项目设置独立权限
   - 难以将项目作为整体导出或复制

2. **权限粒度太粗**:
   - 只能在 Organization 级别设置权限
   - 无法给不同项目分配不同的协作者

3. **缺少模板能力**:
   - 无法复制完整的业务场景（表结构+数据+视图）
   - 新项目启动需要从零配置

### 2.2 Airtable 的解决方案

Airtable 通过 Base 层解决这些问题：

```
Workspace (组织)
  └── Base (项目/数据库) ← 关键层级
      ├── Tables (表)
      ├── Views (视图)
      └── Automations (自动化)
```

**Base 的价值**：
- ✅ 数据隔离单元
- ✅ 权限控制边界
- ✅ 模板复用单位
- ✅ 导出导入单位

---

## 三、用户场景

### 场景 1: 咨询公司多客户管理

**公司**: ABC 咨询公司，服务 20+ 客户

**需求**: 每个客户项目需要独立的：
- 项目数据（任务、文档、工时）
- 访问权限（客户只能看到自己的数据）
- 导出归档（项目结束后整体归档）

**当前方案的问题**:
- 所有客户数据在同一空间，容易误操作
- 无法为单个客户项目设置独立权限
- 难以导出单个客户的完整数据

**Base 方案的优势**:
- 每个客户一个 Base
- 客户只能访问自己的 Base
- 项目结束后一键导出或归档整个 Base

### 场景 2: 软件公司多产品线

**公司**: XYZ 软件公司，3 条产品线

**需求**: 每条产品线有独立的：
- 需求管理、任务跟踪、缺陷管理
- 产品团队和访问权限
- 工作流和自动化规则

**当前方案的问题**:
- 产品线之间的数据结构可能不同，但被迫共享 Object 定义
- 新产品线启动时，无法快速复制模板

**Base 方案的优势**:
- 每条产品线一个 Base
- 可以从模板快速启动新产品线
- 每个 Base 可以有自己的自动化规则

### 场景 3: 个人多项目管理

**用户**: 个人用户管理多个独立项目

**项目示例**:
- 家庭装修计划（预算、供应商、进度）
- 旅行计划（行程、预算、攻略）
- 投资组合跟踪（股票、基金、收益）

**当前方案的问题**:
- 所有项目数据混在一起，难以查找
- 界面混乱，无法快速切换项目上下文

**Base 方案的优势**:
- 每个项目一个 Base
- 清晰的项目列表，快速切换
- 可以为不同项目使用不同的模板

---

## 四、技术方案

### 4.1 轻量级 Base（推荐方案）

**核心思想**: Base 是**元数据容器**，不改变数据存储结构

#### 架构

```
Organization
  └── Base (元数据)
      ├── Objects (belongsTo: baseId)
      ├── Apps (belongsTo: baseId)
      └── Members (Base级别权限)
```

#### 数据模型

1. **新增 2 个对象**:
   - `base` - Base 元数据
   - `base_member` - Base 成员关系

2. **扩展现有对象**:
   - `ObjectConfig.baseId?: string`
   - `AppConfig.baseId?: string`
   - `ObjectQLContext.baseId?: string`

3. **自动过滤机制**:
   - Repository 自动注入 `baseId` 过滤
   - 用户代码无需关心隔离逻辑

#### 优点

- ✅ **最小改动**: 仅增加元数据层
- ✅ **向后兼容**: 现有项目零影响
- ✅ **快速实现**: 2-3 周开发周期
- ✅ **灵活可选**: 用户可选择是否使用

#### 缺点

- ⚠️ 逻辑隔离，非物理隔离
- ⚠️ 需要在 baseId 字段建索引

### 4.2 完整隔离方案（不推荐）

**核心思想**: 每个 Base 独立数据库/Schema

#### 优点
- ✅ 完全物理隔离
- ✅ 性能最优

#### 缺点
- ❌ 实现复杂（6-8 周）
- ❌ 运维成本高
- ❌ 需要数据迁移
- ❌ 数据库连接数激增

---

## 五、实施计划

### 5.1 开发阶段

| 阶段 | 周次 | 内容 | 交付物 |
|------|------|------|--------|
| **阶段 1** | Week 1 | 核心数据模型 | Base 对象定义、TypeScript 类型 |
| **阶段 2** | Week 2 | Repository 集成 | 自动过滤逻辑、权限检查 |
| **阶段 3** | Week 2-3 | API 端点 | Base CRUD、成员管理 API |
| **阶段 4** | Week 3 | UI 组件 | Base 切换器、设置页面 |
| **阶段 5** | Week 3 | 测试文档 | 单元测试、用户文档 |

### 5.2 资源需求

- **人力**: 1 名全栈工程师 × 3 周
- **测试**: 0.5 周
- **总计**: 3.5 人周

### 5.3 里程碑

- **M1 (Week 1)**: 数据模型完成
- **M2 (Week 2)**: 核心逻辑完成
- **M3 (Week 3)**: 功能完整，可用

---

## 六、成本收益分析

### 6.1 投入成本

| 项目 | 成本 |
|------|------|
| 开发时间 | 3.5 人周 |
| 代码维护 | 低（逻辑清晰） |
| 数据库开销 | 忽略不计（2 张表） |
| 文档成本 | 已完成 |

### 6.2 预期收益

| 收益 | 价值 |
|------|------|
| 用户体验提升 | 高（多项目管理更清晰） |
| 权限粒度提升 | 高（项目级别控制） |
| 模板能力 | 中（后续扩展） |
| 市场竞争力 | 高（对标 Airtable） |

### 6.3 ROI 评估

- **短期（3 个月）**: 提升多项目用户满意度
- **中期（6 个月）**: 30% 活跃用户使用 Base 功能
- **长期（12 个月）**: 成为产品核心竞争力

---

## 七、风险评估

### 7.1 技术风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| 性能下降 | 低 | 中 | baseId 索引、缓存 |
| 复杂查询问题 | 中 | 低 | 提供跨 Base API |
| 权限冲突 | 低 | 低 | 明确继承规则 |

### 7.2 用户风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| 概念混淆 | 中 | 低 | 清晰文档、UI 引导 |
| 迁移困难 | 低 | 低 | 支持不迁移 |

### 7.3 总体风险

**风险等级**: 🟢 低

**理由**:
- 向后兼容，现有用户无影响
- 实现简单，技术成熟
- 增量发布，可逐步优化

---

## 八、竞品对比

| 产品 | Base/Workspace | 实现方式 | 优势 | 劣势 |
|------|---------------|---------|------|------|
| **Airtable** | Base (核心) | 物理隔离 | 完整生态 | 闭源、昂贵 |
| **Notion** | Database | 逻辑隔离 | 灵活性高 | 性能一般 |
| **NocoDB** | Project | 物理隔离 | 开源免费 | 功能有限 |
| **Baserow** | Database | 逻辑隔离 | 简单易用 | 生态弱 |
| **ObjectQL** | 无 → Base | 逻辑隔离 | AI原生、开源 | 需实现 |

**结论**: 实现 Base 是对标竞品的关键一步

---

## 九、决策建议

### 9.1 核心建议

✅ **强烈建议实施轻量级 Base 层**

### 9.2 理由

1. **填补架构缺口**: Organization 和 Object 之间缺少中间层
2. **用户需求明确**: 多项目场景是常见痛点
3. **成本可控**: 3.5 人周，风险低
4. **向后兼容**: 零迁移成本
5. **战略意义**: 对标 Airtable 的关键步骤

### 9.3 不实施的影响

如果不实施 Base 层：

- ❌ 多项目用户体验不佳
- ❌ 无法提供项目级别权限控制
- ❌ 模板能力受限
- ❌ 落后于竞品（Airtable、Notion）
- ❌ 错失市场机会

---

## 十、成功指标

### 10.1 功能指标

- ✅ P0 功能 100% 完成（Base CRUD、权限、切换）
- ✅ P1 功能 80% 完成（模板、复制、归档）
- ✅ 向后兼容 100%

### 10.2 性能指标

- ✅ 查询性能下降 < 5%
- ✅ Base 切换时间 < 500ms
- ✅ 支持 1000+ 记录无卡顿

### 10.3 用户指标

- ✅ 30% 活跃用户创建多个 Bases（6 个月内）
- ✅ 用户满意度 > 4.5/5
- ✅ 零迁移问题投诉

---

## 十一、决策流程

### 11.1 决策点

**是否实施 Base 层？**

- [ ] 是 → 继续下一步
- [ ] 否 → 说明原因，存档

### 11.2 如果批准

**立即行动**（本周）:
- [ ] 评审本提案
- [ ] 分配开发资源
- [ ] 设置项目跟踪

**Week 1**:
- [ ] 启动阶段 1 开发
- [ ] 每日站会同步进度

**Week 2-3**:
- [ ] 继续开发
- [ ] 内部测试
- [ ] 文档完善

**Week 4**:
- [ ] Beta 发布
- [ ] 收集反馈
- [ ] 迭代优化

### 11.3 如果不批准

**备选方案**:
- 方案 A: 延期到下一季度
- 方案 B: 实施更轻量的变体（仅元数据，不改 UI）
- 方案 C: 不实施，维持现状

---

## 十二、附录

### A. 文档清单

1. ✅ **BASE_LAYER_EVALUATION.md** - 完整评估报告
2. ✅ **BASE_IMPLEMENTATION_GUIDE.md** - 技术实施指南
3. ✅ **BASE_LAYER_SUMMARY.md** - 快速参考
4. ✅ **BASE_DOCS_INDEX.md** - 文档索引
5. ✅ **base.object.yml** - Base 对象定义
6. ✅ **base_member.object.yml** - Base 成员定义

### B. 参考资料

- [Airtable Bases 官方文档](https://support.airtable.com/docs/getting-started-with-airtable-bases)
- [ObjectQL 现有架构文档](./ORGANIZATION_IMPLEMENTATION_CN.md)
- [竞品分析](./AIRTABLE_EVALUATION.md)

---

## 决策签字

**提案人**: ObjectQL Core Team  
**日期**: 2026-01-09

**决策人**: _________________  
**决策**: [ ] 批准  [ ] 拒绝  [ ] 延期  
**签字**: _________________  
**日期**: _________________

**备注**:

---

**文档版本**: 1.0  
**状态**: 待决策  
**更新日期**: 2026-01-09
