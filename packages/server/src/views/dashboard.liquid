{% layout "layout.liquid" %}

{% block content %}
<!-- Dashboard Content -->
{% endblock %}

{% block scripts %}
    function SidebarItem({ icon: Icon, label, active, onClick }) {
        return (
            <button 
                onClick={onClick}
                className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg transition-all duration-200 group ${active ? 'bg-white shadow-sm text-blue-600' : 'text-gray-500 hover:bg-black/5 hover:text-gray-900'}`}
            >
                <Icon className={`w-5 h-5 ${active ? 'text-blue-600' : 'text-gray-400 group-hover:text-gray-600'}`} />
                <span className="font-medium text-[14px]">{label}</span>
            </button>
        );
    }

    const { AutoForm: UIAutoForm } = ObjectQLUI;

    function useRouter() {
        const [path, setPath] = useState(window.location.pathname);
        useEffect(() => {
            const onPopState = () => setPath(window.location.pathname);
            window.addEventListener('popstate', onPopState);
            return () => window.removeEventListener('popstate', onPopState);
        }, []);
        
        const navigate = (newPath) => {
            window.history.pushState({}, '', newPath);
            setPath(newPath);
        };
        
        return { path, navigate };
    }

    function ObjectForm({ objectName, initialValues, onSubmit, onCancel, headers }) {
        const [schema, setSchema] = useState(null);
        
        useEffect(() => {
             fetch(`/api/object/_schema/object/${objectName}`, { headers })
                .then(res => res.json())
                .then(setSchema)
                .catch(console.error);
        }, [objectName]);

        if (!schema) return <div className="p-8 flex justify-center"><Spinner className="w-6 h-6 text-gray-400" /></div>;

        return (
            <UIAutoForm 
                schema={schema}
                initialValues={initialValues}
                onSubmit={onSubmit}
                onCancel={onCancel}
            />
        );
    }

    function ObjectListView({ objectName, user, isCreating, navigate, objectSchema }) {
        const [data, setData] = useState([]);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState(null);
        
        const label = objectSchema?.label || objectSchema?.title || objectName;
        
        // Helper to get field label
        const getFieldLabel = (key) => {
            if (!objectSchema || !objectSchema.fields) return key;
            const field = objectSchema.fields[key];
            return field ? (field.label || field.title || key) : key;
        };

        const getHeaders = () => {
            const headers = { 'Content-Type': 'application/json' };
            headers['x-user-id'] = 'admin'; 
            return headers;
        };

        const handleCreate = (formData) => {
            fetch(`/api/object/${objectName}`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify(formData)
            })
            .then(async res => {
                if (!res.ok) throw new Error(await res.text());
                return res.json();
            })
            .then(() => {
                navigate(`/object/${objectName}`);
                fetchData();
            })
            .catch(err => alert(err.message));
        }

        const handleDelete = (e, item) => {
            e.stopPropagation();
            if (!confirm('Are you sure you want to delete this record?')) return;
            const id = item.id || item._id;
            
            fetch(`/api/object/${objectName}/${id}`, {
                method: 'DELETE',
                headers: getHeaders()
            })
            .then(async res => {
                if (!res.ok) throw new Error(await res.text());
                fetchData(); // Refresh list
            })
            .catch(err => alert(err.message));
        }

        const fetchData = () => {
            if (!objectName) return;
            setLoading(true);
            setError(null);
            
            fetch(`/api/object/${objectName}`, { headers: getHeaders() })
                .then(async res => {
                    if (!res.ok) {
                        const contentType = res.headers.get("content-type");
                        if (contentType && contentType.indexOf("application/json") !== -1) {
                            const json = await res.json();
                            throw new Error(json.error || "Failed to load data");
                        }
                        throw new Error(await res.text() || res.statusText);
                    }
                    return res.json();
                })
                .then(result => {
                    const items = Array.isArray(result) ? result : (result.list || []);
                    setData(items);
                })
                .catch(err => {
                    console.error(err);
                    setError(err.message);
                    setData([]);
                })
                .finally(() => setLoading(false));
        };

        useEffect(() => {
            if (user && objectName) fetchData();
        }, [objectName, user]);

        const ModalContent = () => (
            <ObjectForm 
                objectName={objectName} 
                initialValues={ {} }
                headers={getHeaders()}
                onSubmit={handleCreate} 
                onCancel={() => navigate(`/object/${objectName}`)} 
            />
        );

        return (
            <div className="flex flex-col h-full bg-white rounded-xl border border-gray-200/60 shadow-sm overflow-hidden animate-[fadeIn_0.3s_ease-out]">
                 <div className="min-h-[60px] px-6 border-b border-gray-100 flex justify-between items-center bg-white">
                     <div>
                         <h3 className="font-bold text-gray-900 text-lg flex items-center gap-2">
                            <i className={`ri-${objectSchema?.icon || 'file-list-2-line'} text-xl text-gray-400`} />
                            {label}
                            <span className="px-2 py-0.5 rounded-full bg-gray-100 text-gray-500 text-xs font-medium">{data.length} records</span>
                         </h3>
                     </div>
                     <div className="flex gap-2">
                         <Button onClick={fetchData} variant="secondary" className="h-8 text-xs px-3 shadow-none border-gray-200">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-1.5"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                            Refresh
                         </Button>
                         <Button variant="secondary" className="h-8 text-xs px-3 shadow-none border-gray-200">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-1.5"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                            Filter
                         </Button>
                         <Button onClick={() => navigate(`/object/${objectName}/new`)} className="h-8 text-xs px-3 shadow-none bg-black hover:bg-gray-800">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-1.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            New Record
                         </Button>
                     </div>
                </div>
                
                <div className="flex-1 overflow-auto bg-white relative">
                    {loading && (
                        <div className="absolute inset-0 bg-white/50 backdrop-blur-sm z-10 flex items-center justify-center">
                            <Spinner className="w-6 h-6 text-blue-500" />
                        </div>
                    )}
                    
                    {error ? (
                         <div className="flex flex-col items-center justify-center h-full text-red-500 p-8 text-center">
                            <i className="ri-layout-line text-4xl mb-4 opacity-50 block" />
                            <p className="font-medium">Error loading data</p>
                            <p className="text-sm opacity-75 max-w-md break-words">{error}</p>
                            <Button onClick={fetchData} variant="secondary" className="mt-4">Try Again</Button>
                        </div>
                    ) : data.length === 0 ? (
                        <div className="flex flex-col items-center justify-center h-full text-gray-300 p-8">
                            <i className={`ri-${objectSchema?.icon || 'database-2-line'} text-6xl mb-4 opacity-50`} />
                            <p className="text-sm font-medium text-gray-400">No records found for {label}</p>
                        </div>
                    ) : (
                        <table className="w-full text-left border-collapse text-sm">
                            <thead className="bg-gray-50/80 sticky top-0 z-10 backdrop-blur-sm">
                                <tr>
                                    {Object.keys(data[0] || {}).map(key => (
                                        <th key={key} className="px-6 py-3 font-semibold text-gray-500 border-b border-gray-100 whitespace-nowrap text-xs uppercase tracking-wider">
                                            {getFieldLabel(key)}
                                        </th>
                                    ))}
                                    <th className="px-6 py-3 font-semibold text-gray-500 border-b border-gray-100 whitespace-nowrap text-xs uppercase tracking-wider text-right">
                                        Actions
                                    </th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {data.map((row, idx) => (
                                    <tr 
                                        key={idx} 
                                        onClick={() => navigate(`/object/${objectName}/${row.id || row._id}`)}
                                        className="hover:bg-blue-50/30 transition-colors group cursor-pointer"
                                    >
                                        {Object.keys(data[0] || {}).map(key => (
                                            <td key={key} className="px-6 py-3.5 text-gray-700 whitespace-nowrap max-w-xs overflow-hidden text-ellipsis font-normal group-hover:text-blue-600">
                                                {typeof row[key] === 'object' ? 
                                                    <span className="font-mono text-xs text-gray-400">{JSON.stringify(row[key])}</span> : 
                                                    String(row[key])
                                                }
                                            </td>
                                        ))}
                                        <td className="px-6 py-3.5 text-right whitespace-nowrap">
                                            <div className="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button onClick={(e) => { e.stopPropagation(); navigate(`/object/${objectName}/${row.id || row._id}`); }} className="p-1 text-gray-400 hover:text-blue-600 transition-colors" title="View/Edit">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                                </button>
                                                <button onClick={(e) => handleDelete(e, row)} className="p-1 text-gray-400 hover:text-red-600 transition-colors" title="Delete">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    )}
                </div>

                <Modal 
                    isOpen={isCreating} 
                    onClose={() => navigate(`/object/${objectName}`)} 
                    title={`New ${label}`}
                >
                    <ModalContent />
                </Modal>
            </div>
        );
    }

    function ObjectDetailView({ objectName, recordId, navigate, objectSchema }) {
        const [data, setData] = useState(null);
        const [schema, setSchema] = useState(null);
        const [isEditing, setIsEditing] = useState(false);
        const [loading, setLoading] = useState(true);
        
        const label = objectSchema?.label || objectSchema?.title || objectName;

        const getHeaders = () => {
             const headers = { 'Content-Type': 'application/json' };
             headers['x-user-id'] = 'admin'; 
             return headers;
        };

        useEffect(() => {
            setLoading(true);
            Promise.all([
                fetch(`/api/object/${objectName}/${recordId}`, { headers: getHeaders() }).then(async r => {
                     if (!r.ok) throw new Error("Failed to load record");
                     return r.json();
                }),
                fetch(`/api/object/_schema/object/${objectName}`, { headers: getHeaders() }).then(r => r.json())
            ]).then(([record, schemaData]) => {
                setData(record);
                setSchema(schemaData);
            }).catch(console.error)
            .finally(() => setLoading(false));
        }, [objectName, recordId]);

        const handleDelete = () => {
             if (!confirm('Are you sure you want to delete this record?')) return;
             fetch(`/api/object/${objectName}/${recordId}`, {
                method: 'DELETE',
                headers: getHeaders()
            }).then(() => navigate(`/object/${objectName}`))
            .catch(e => alert(e.message));
        };
        
        const handleUpdate = (formData) => {
             fetch(`/api/object/${objectName}/${recordId}`, {
                method: 'PUT',
                headers: getHeaders(),
                body: JSON.stringify(formData)
            }).then(async res => {
                if(!res.ok) throw new Error(await res.text());
                return res.json();
            }).then(() => {
                setIsEditing(false);
                // Reload data
                fetch(`/api/object/${objectName}/${recordId}`, { headers: getHeaders() })
                    .then(r => r.json())
                    .then(setData);
            }).catch(e => alert(e.message));
        };

        if (loading) return (
            <div className="flex flex-col h-full bg-white rounded-xl border border-gray-200/60 shadow-sm overflow-hidden p-8 items-center justify-center">
                <Spinner className="w-6 h-6 text-gray-400" />
            </div>
        );
        
        if (!data) return <div>Record not found</div>;

        return (
            <div className="flex flex-col h-full bg-white rounded-xl border border-gray-200/60 shadow-sm overflow-hidden animate-[fadeIn_0.3s_ease-out]">
                 {/* Header */}
                 <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-white">
                    <div className="flex items-center gap-4">
                        <button onClick={() => navigate(`/object/${objectName}`)} className="p-2 -ml-2 hover:bg-gray-100 rounded-full transition-colors text-gray-500">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
                        </button>
                        <div>
                            <div className="flex items-center gap-2 text-xs text-gray-500 uppercase font-medium tracking-wider mb-0.5">
                                {label}
                                <span className="text-gray-300">/</span>
                                <span className="text-gray-400">{recordId}</span>
                            </div>
                            <h1 className="text-xl font-bold text-gray-900">{data.name || data.title || recordId}</h1>
                        </div>
                    </div>
                    
                    <div className="flex gap-2">
                        <Button variant="secondary" onClick={() => setIsEditing(true)} className="gap-2">
                             <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                             Edit
                        </Button>
                        <Button variant="secondary" onClick={handleDelete} className="hover:bg-red-50 hover:text-red-600 gap-2 border-transparent">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            Delete
                        </Button>
                    </div>
                 </div>

                 {/* Content */}
                 <div className="flex-1 overflow-auto bg-gray-50/50 p-6">
                     <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-6 max-w-4xl mx-auto">
                        {schema ? (
                            <UIAutoForm 
                                schema={schema} 
                                initialValues={data} 
                                readonly={true} 
                                onSubmit={() => {}}
                            />
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-8">
                                {Object.entries(data).map(([key, value]) => (
                                    <div key={key} className="space-y-1.5 border-b border-gray-50 pb-2">
                                        <div className="text-xs font-medium text-gray-400 uppercase tracking-wide">{key}</div>
                                        <div className="text-sm text-gray-900 font-medium break-words">
                                            {typeof value === 'object' ? JSON.stringify(value) : String(value ?? '-')}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                     </div>
                 </div>

                 {/* Edit Modal */}
                 <Modal isOpen={isEditing} onClose={() => setIsEditing(false)} title={`Edit ${label}`}>
                      <UIAutoForm 
                        schema={schema}
                        initialValues={data}
                        onSubmit={handleUpdate}
                        onCancel={() => setIsEditing(false)}
                      />
                 </Modal>
            </div>
        );
    }

    function DashboardApp() {
        const [user, setUser] = useState(null);
        const [loading, setLoading] = useState(true);
        const [objects, setObjects] = useState([]);
        const { path, navigate } = useRouter();
        
        const parts = path.split('/').filter(Boolean);
        const isSettings = path === '/settings';
        const isObjectView = parts[0] === 'object';
        const selectedObject = isObjectView ? parts[1] : null;
        const recordId = isObjectView ? parts[2] : null;

        const getHeaders = () => {
             const headers = { 'Content-Type': 'application/json' };
             // Admin override for Data Explorer
             headers['x-user-id'] = 'admin'; 
             return headers;
        };

        useEffect(() => {
            authClient.getSession().then(session => {
                if (!session || !session.user) {
                    window.location.href = '/login';
                } else {
                    setUser(session.user);
                    
                    // Fetch objects once auth is confirmed
                    fetch('/api/object/_schema/object', { headers: getHeaders() })
                        .then(res => res.json())
                        .then(result => {
                            const objNames = Object.keys(result);
                            setObjects(result);
                            
                            const path = window.location.pathname;
                            if ((path === '/' || path === '/object') && objNames.length > 0) {
                                navigate(`/object/${objNames[0]}`);
                            }

                            setLoading(false);
                        })
                        .catch(err => {
                            console.error("Failed to fetch objects", err);
                            setLoading(false);
                        });
                }
            }).catch(() => {
                window.location.href = '/login';
            });
        }, []);

        if (loading) {
            return (
                <div className="flex h-screen w-full items-center justify-center bg-[#F5F5F7]">
                    <Spinner className="w-6 h-6 text-gray-400" />
                </div>
            );
        }

        return (
            <div className="flex h-screen overflow-hidden bg-[#F5F5F7]">
                {/* Sidebar */}
                <aside className="w-[260px] bg-[#FBFBFD] border-r border-gray-200/80 flex flex-col justify-between pt-6 pb-6 shadow-[4px_0_24px_-12px_rgba(0,0,0,0.05)] z-20">
                     <div className="px-5 flex flex-col h-full">
                        <div className="flex items-center gap-3 mb-8 px-2 flex-shrink-0">
                            <div className="w-8 h-8 bg-black rounded-lg flex items-center justify-center shadow-md shadow-black/20">
                                <i className="ri-database-2-fill text-white text-lg"></i>
                            </div>
                            <div>
                                <div className="text-[15px] font-bold tracking-tight text-gray-900 leading-none">ObjectQL</div>
                                <div className="text-[11px] text-gray-500 font-medium mt-0.5">Admin Server</div>
                            </div>
                        </div>

                        <div className="mb-2 px-2 flex-shrink-0">
                            <h3 className="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Collections</h3>
                        </div>
                        
                        <nav className="space-y-0.5 overflow-y-auto flex-1 -mx-2 px-2 no-scrollbar">
                            {Object.entries(objects).map(([name, schema]) => (
                                <SidebarItem 
                                    key={name}
                                    icon={() => <i className={`ri-${schema.icon || 'file-list-2-line'} text-lg`} />}
                                    label={schema.label || schema.title || name}
                                    active={!isSettings && selectedObject === name}
                                    onClick={() => navigate(`/object/${name}`)}
                                />
                            ))}
                        </nav>

                        <div className="mt-4 pt-4 border-t border-gray-100 flex-shrink-0">
                             <SidebarItem 
                                icon={() => <i className="ri-settings-3-line text-lg" />}
                                label="Server Settings" 
                                active={isSettings} 
                                onClick={() => navigate('/settings')} 
                            />
                        </div>
                     </div>

                     <div className="px-5 mt-4 flex-shrink-0">
                        <div className="p-3 bg-white border border-gray-200/60 rounded-xl shadow-sm flex items-center gap-3">
                            <div className="w-9 h-9 rounded-full bg-stone-800 text-white flex items-center justify-center text-sm font-bold shadow-inner">
                                {user.name?.[0]?.toUpperCase() || 'U'}
                            </div>
                            <div className="flex-1 min-w-0">
                                <p className="text-sm font-semibold text-gray-900 truncate">{user.name}</p>
                                <p className="text-xs text-gray-500 truncate">Administrator</p>
                            </div>
                            <button onClick={() => authClient.signOut()} className="text-gray-400 hover:text-red-500 transition-colors p-1" title="Sign Out">
                                <i className="ri-logout-box-r-line text-lg" />
                            </button>
                        </div>
                     </div>
                </aside>

                {/* Main Content */}
                <main className="flex-1 overflow-auto bg-white/50">
                    {!isSettings && selectedObject ? (
                         recordId && recordId !== 'new' ? (
                            <ObjectDetailView 
                                objectName={selectedObject}
                                recordId={recordId}
                                navigate={navigate}
                                objectSchema={objects[selectedObject]}
                            />
                        ) : (
                            <ObjectListView 
                                objectName={selectedObject} 
                                user={user} 
                                isCreating={recordId === 'new'}
                                navigate={navigate}
                                objectSchema={objects[selectedObject]}
                            />
                        )
                    ) : isSettings ? (
                         <div className="p-8 max-w-4xl mx-auto animate-[fadeIn_0.3s_ease-out]">
                            <h2 className="text-2xl font-bold text-gray-900 mb-6">Server Settings</h2>
                            <Card title="About ObjectQL" description="System information and status.">
                                <div className="space-y-4">
                                    <div className="flex justify-between py-2 border-b border-gray-100">
                                        <span className="text-gray-500">Version</span>
                                        <span className="font-medium">v0.2.0</span>
                                    </div>
                                    <div className="flex justify-between py-2 border-b border-gray-100">
                                        <span className="text-gray-500">Environment</span>
                                        <span className="font-medium">Development</span>
                                    </div>
                                </div>
                            </Card>
                        </div>
                    ) : (
                        <div className="flex h-full items-center justify-center text-gray-400">
                            Select an object to view data
                        </div>
                    )}
                </main>
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<DashboardApp />);
{% endblock %}

