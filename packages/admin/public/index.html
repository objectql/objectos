<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50 antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <title>ObjectQL Admin</title>
    
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.1.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.8/dist/cdn.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                    },
                    colors: {
                        ios: {
                            blue: '#007AFF',
                            gray: '#8E8E93',
                            bg: '#F2F2F7',
                            card: '#FFFFFF',
                            separator: '#C6C6C8',
                            destruct: '#FF3B30'
                        }
                    },
                    boxShadow: {
                        'ios': '0 1px 2px rgba(0,0,0,0.04), 0 4px 16px rgba(0,0,0,0.02)',
                        'ios-hover': '0 4px 12px rgba(0,0,0,0.08), 0 8px 24px rgba(0,0,0,0.04)',
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
        
        /* iOS-like Scrolling */
        .ios-scroll {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .ios-scroll::-webkit-scrollbar {
            display: none;
        }

        /* Glassmorphism for mobile header */
        .glass-header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
        }

        /* Responsive Modal Animations */
        .mobile-sheet {
            transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
        }
    </style>
</head>
<body class="h-full flex flex-col md:flex-row text-gray-900 overflow-hidden bg-ios-bg" x-data="app()" x-init="initApp()" x-cloak>

    <!-- Mobile Header -->
    <header class="md:hidden h-14 glass-header border-b border-gray-200 flex items-center justify-between px-4 fixed top-0 w-full z-40">
        <button @click="isMobileMenuOpen = !isMobileMenuOpen" class="text-ios-blue text-lg">
            <i class="ri-menu-line" x-show="!isMobileMenuOpen"></i>
            <i class="ri-close-line" x-show="isMobileMenuOpen"></i>
        </button>
        <span class="font-semibold text-base" x-text="currentObject?.label || 'ObjectQL'"></span>
        <button class="text-ios-blue text-lg" @click="currentObject && openModal()">
            <i class="ri-add-line"></i>
        </button>
    </header>

    <!-- Sidebar (Desktop & Mobile Drawer) -->
    <div 
        class="fixed inset-0 bg-black/30 z-30 md:hidden transition-opacity duration-300"
        x-show="isMobileMenuOpen"
        x-transition:enter="opacity-0" x-transition:enter-end="opacity-100"
        x-transition:leave="opacity-100" x-transition:leave-end="opacity-0"
        @click="isMobileMenuOpen = false"
    ></div>

    <aside 
        class="fixed inset-y-0 left-0 w-72 bg-ios-bg md:bg-[#F9F9FB] border-r border-[#D1D1D4] z-40 transform transition-transform duration-300 md:relative md:transform-none flex flex-col"
        :class="isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'"
    >
        <div class="h-14 md:h-16 flex items-center px-5 flex-shrink-0 border-b border-gray-200 md:border-transparent">
            <div class="flex items-center gap-2.5">
                <div class="w-8 h-8 rounded-lg bg-ios-blue text-white flex items-center justify-center shadow-sm">
                    <i class="ri-database-2-fill text-lg"></i>
                </div>
                <h1 class="font-bold text-lg tracking-tight">ObjectQL</h1>
            </div>
        </div>

        <div class="px-3 py-2 flex-1 ios-scroll overflow-y-auto">
            <h2 class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 mt-2">Database</h2>
            <div class="space-y-0.5">
                <template x-for="obj in objects" :key="obj.name">
                    <button 
                        @click="selectObject(obj)"
                        class="w-full text-left px-3 py-2.5 rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-3 active:scale-95 transform"
                        :class="currentObject && currentObject.name === obj.name ? 'bg-white text-ios-blue shadow-ios' : 'text-gray-600 hover:bg-black/5'"
                    >
                        <i class="ri-table-fill opacity-80" :class="currentObject && currentObject.name === obj.name ? 'text-ios-blue' : 'text-gray-400'"></i>
                        <span x-text="obj.label || obj.name"></span>
                        <i class="ri-arrow-right-s-line ml-auto text-gray-300"></i>
                    </button>
                </template>
            </div>
        </div>
        
        <div class="p-4 border-t border-[#D1D1D4] bg-white/50 backdrop-blur-sm">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-500">
                    <i class="ri-user-fill"></i>
                </div>
                <div class="text-sm">
                    <div class="font-medium text-gray-900">Administrator</div>
                    <div class="text-gray-500 text-xs">System</div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative h-full pt-14 md:pt-0 overflow-hidden" @click="isMobileMenuOpen = false">
        
        <div x-show="!currentObject" class="flex-1 flex items-center justify-center p-6 text-center text-gray-400">
            <div>
                <i class="ri-command-line text-4xl mb-4 block opacity-20"></i>
                <p>Select an object to manage data</p>
            </div>
        </div>

        <div x-show="currentObject" class="flex-1 flex flex-col h-full w-full max-w-7xl mx-auto">
            
            <!-- Desktop Toolbar -->
            <div class="hidden md:flex h-16 items-center justify-between px-6 md:px-8 border-b border-gray-200 bg-white sticky top-0 z-20">
                <div>
                    <h2 class="text-xl font-bold text-gray-900" x-text="currentObject?.label || currentObject?.name"></h2>
                </div>
                <div class="flex items-center gap-3">
                    <button @click="loadData()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors flex items-center justify-center">
                        <i class="ri-refresh-line" :class="{'animate-spin': loading}"></i>
                    </button>
                    <button @click="openModal()" class="px-4 py-1.5 bg-ios-blue hover:bg-blue-600 text-white text-sm font-medium rounded-full shadow-ios hover:shadow-ios-hover transition-all active:scale-95 flex items-center gap-1.5">
                        <i class="ri-add-line"></i>
                        <span>New</span>
                    </button>
                </div>
            </div>

            <!-- Content Area -->
            <div class="flex-1 overflow-y-auto ios-scroll p-4 md:p-8">
                
                <div x-show="error" class="mb-4 bg-red-50 text-red-600 px-4 py-3 rounded-xl border border-red-100 text-sm flex items-center gap-2">
                    <i class="ri-error-warning-fill"></i>
                    <span x-text="error"></span>
                </div>

                <!-- Card List (Mobile) -->
                <div class="md:hidden space-y-3 pb-20">
                     <template x-for="row in records" :key="row._id || row.id">
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 active:scale-[0.98] transition-transform" @click="openModal(row)">
                             <div class="flex justify-between items-start mb-2">
                                <h3 class="font-semibold text-gray-900" x-text="getRowTitle(row)"></h3>
                                <span class="text-xs text-gray-400 font-mono" x-text="(row._id || row.id).toString().slice(-4)"></span>
                             </div>
                             <div class="space-y-1">
                                <template x-for="field in displayFields.slice(1, 4)" :key="field.name">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-500" x-text="field.label || field.name"></span>
                                        <span class="text-gray-900 font-medium truncate max-w-[150px]" x-text="formatValue(row[field.name], field)"></span>
                                    </div>
                                </template>
                             </div>
                        </div>
                     </template>
                     <div x-show="records.length === 0 && !loading" class="text-center py-10 text-gray-500">
                        No records
                     </div>
                </div>

                <!-- Table (Desktop) -->
                <div class="hidden md:block bg-white rounded-xl shadow-ios border border-gray-100 overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-100">
                        <thead class="bg-gray-50/50">
                            <tr>
                                <template x-for="field in displayFields" :key="field.name">
                                    <th class="px-6 py-3.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider" x-text="field.label || field.name"></th>
                                </template>
                                <th class="px-6 py-3.5 w-10"></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100 bg-white">
                            <template x-for="row in records" :key="row._id || row.id">
                                <tr class="hover:bg-gray-50/80 transition-colors group cursor-pointer" @click="openModal(row)">
                                    <template x-for="field in displayFields" :key="field.name">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 group-hover:text-black">
                                            <span x-text="formatValue(row[field.name], field)"></span>
                                        </td>
                                    </template>
                                    <td class="px-6 py-4 text-right text-sm font-medium">
                                        <i class="ri-arrow-right-s-line text-gray-300 group-hover:text-gray-500"></i>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div x-show="records.length === 0 && !loading" class="text-center py-16 text-gray-400">
                        <i class="ri-inbox-line text-4xl opacity-20 mb-3 block"></i>
                        No records found
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal / Sheet -->
    <div x-show="isModalOpen" class="relative z-50">
        <div class="fixed inset-0 bg-black/40 backdrop-blur-[2px] transition-opacity duration-300" x-transition:enter="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="opacity-100" x-transition:leave-end="opacity-0" @click="closeModal()"></div>

        <!-- Desktop Modal / Mobile Sheet -->
        <div class="fixed inset-x-0 bottom-0 md:inset-0 md:flex md:items-center md:justify-center pointer-events-none">
            
            <div 
                class="bg-white w-full md:w-[600px] md:rounded-2xl md:shadow-2xl h-[90vh] md:h-auto md:max-h-[85vh] flex flex-col pointer-events-auto mobile-sheet rounded-t-2xl transform"
                x-transition:enter="translate-y-full md:transition md:duration-200 md:ease-out md:scale-95 md:opacity-0 md:translate-y-0"
                x-transition:enter-end="translate-y-0 md:scale-100 md:opacity-100"
                x-transition:leave="translate-y-full md:transition md:duration-150 md:ease-in md:scale-95 md:opacity-0 md:translate-y-0"
            >
                <!-- Drag Handle (Mobile) -->
                <div class="md:hidden h-6 flex items-center justify-center pt-2 pb-1" @click="closeModal()">
                    <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
                </div>

                <!-- Header -->
                <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-white md:rounded-t-2xl sticky top-0 z-10">
                    <h3 class="text-lg font-bold text-gray-900">
                        <span x-text="editId ? 'Edit Record' : 'New Record'"></span>
                    </h3>
                    <div class="flex gap-4">
                         <button x-show="editId" @click="deleteRecord(editId)" class="text-red-500 font-medium text-sm hover:opacity-80 transition-opacity">Delete</button>
                         <button @click="closeModal()" class="md:block hidden text-gray-400 hover:text-gray-600">
                            <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                                <i class="ri-close-line text-lg"></i>
                            </div>
                        </button>
                         <button @click="closeModal()" class="md:hidden text-ios-blue font-medium">Cancel</button>

                    </div>
                </div>

                <!-- Content -->
                <div class="flex-1 overflow-y-auto ios-scroll p-6 bg-[#F9F9FB] md:bg-white">
                    <form id="recordForm" @submit.prevent="saveRecord()" class="space-y-5">
                        <template x-for="field in formFields" :key="field.name">
                            <div class="bg-white md:bg-transparent rounded-xl px-4 py-3 md:p-0 border border-gray-100 md:border-0 shadow-sm md:shadow-none">
                                <label :for="field.name" class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1.5" x-text="field.label || field.name"></label>
                                
                                <template x-if="(field.type === 'select' && field.options) || field.type === 'boolean'">
                                    <div class="relative">
                                        <select :id="field.name" class="appearance-none block w-full bg-[#F2F2F7] md:bg-gray-50 border-0 rounded-lg py-3 px-4 text-gray-900 focus:ring-2 focus:ring-ios-blue focus:bg-white transition-all text-base" x-model="formData[field.name]">
                                            <template x-if="field.type === 'boolean'">
                                                <optgroup>
                                                    <option :value="true">Yes</option>
                                                    <option :value="false">No</option>
                                                </optgroup>
                                            </template>
                                            <template x-if="userOptions(field)">
                                                <optgroup>
                                                   <template x-for="opt in userOptions(field)" :key="opt.value">
                                                       <option :value="opt.value" x-text="opt.label"></option>
                                                   </template>
                                                </optgroup>
                                           </template>
                                        </select>
                                        <div class="absolute inset-y-0 right-3 flex items-center pointer-events-none text-gray-500">
                                            <i class="ri-arrow-up-down-line text-sm"></i>
                                        </div>
                                    </div>
                                </template>

                                <template x-if="field.type === 'textarea'">
                                    <textarea :id="field.name" rows="3" class="block w-full bg-[#F2F2F7] md:bg-gray-50 border-0 rounded-lg py-3 px-4 text-gray-900 placeholder:text-gray-400 focus:ring-2 focus:ring-ios-blue focus:bg-white transition-all text-base resize-none" x-model="formData[field.name]"></textarea>
                                </template>

                                <template x-if="!['select', 'boolean', 'textarea'].includes(field.type)">
                                    <input 
                                        :type="field.type === 'number' ? 'number' : 'text'" 
                                        :id="field.name" 
                                        class="block w-full bg-[#F2F2F7] md:bg-gray-50 border-0 rounded-lg py-3 px-4 text-gray-900 placeholder:text-gray-400 focus:ring-2 focus:ring-ios-blue focus:bg-white transition-all text-base" 
                                        x-model="formData[field.name]"
                                    >
                                </template>
                            </div>
                        </template>
                    </form>
                </div>

                <!-- Footer -->
                <div class="p-4 border-t border-gray-100 bg-white md:rounded-b-2xl pb-safe">
                    <button form="recordForm" type="submit" class="w-full bg-ios-blue hover:bg-blue-600 text-white font-semibold py-3.5 rounded-xl shadow-lg shadow-blue-500/30 active:scale-[0.98] transition-all text-lg md:text-base">
                        Save
                    </button>
                    <div class="md:hidden h-4"></div> <!-- Bottom safe area spacer -->
                </div>
            </div>
        </div>
    </div>

    <script>
        function app() {
            return {
                isMobileMenuOpen: false,
                API_BASE: '/api',
                HEADERS: { 'X-User-Id': 'admin', 'Content-Type': 'application/json' },
                
                objects: [],
                currentObject: null,
                records: [],
                loading: false,
                error: null,
                
                isModalOpen: false,
                editId: null,
                formData: {},

                async initApp() {
                    try {
                        const res = await fetch(`${this.API_BASE}/_schema`, { headers: this.HEADERS });
                        if (!res.ok) throw new Error("Could not load schema");
                        const schemas = await res.json();
                        this.objects = Object.values(schemas);
                        // Auto-select first if desktop
                        if(window.innerWidth > 768 && this.objects.length > 0) {
                            this.selectObject(this.objects[0]);
                        }
                    } catch (e) {
                        this.error = e.message;
                    }
                },

                selectObject(obj) {
                    this.currentObject = obj;
                    this.isMobileMenuOpen = false;
                    this.loadData();
                },

                async loadData() {
                    if (!this.currentObject) return;
                    this.loading = true;
                    this.error = null;
                    try {
                        const res = await fetch(`${this.API_BASE}/${this.currentObject.name}?sort=created:desc`, { headers: this.HEADERS });
                        if (!res.ok) throw new Error(await res.text());
                        this.records = await res.json();
                    } catch (e) {
                        this.error = e.message;
                        this.records = [];
                    } finally {
                        this.loading = false;
                    }
                },

                get displayFields() {
                    if (!this.currentObject) return [];
                    return Object.values(this.currentObject.fields).filter(f => !['_id', 'password'].includes(f.name)).slice(0, 5);
                },

                get formFields() {
                    if (!this.currentObject) return [];
                    return Object.values(this.currentObject.fields).filter(f => !['_id', 'id', 'created', 'modified'].includes(f.name));
                },
                
                userOptions(field) { return field.options; },

                formatValue(value, field) {
                    if (value === null || value === undefined) return '';
                    if (field.type === 'boolean') return value ? 'Yes' : 'No';
                    if (typeof value === 'object') return JSON.stringify(value);
                    return value;
                },

                getRowTitle(row) {
                    // Try to guess the "title" field: name, title, label, etc.
                    const fields = this.displayFields;
                    const titleField = fields.find(f => ['name', 'title', 'subject'].includes(f.name)) || fields[0];
                    return titleField ? row[titleField.name] : 'Record';
                },

                openModal(record = null) {
                    this.editId = record ? (record._id || record.id) : null;
                    this.formData = {};
                    
                    this.formFields.forEach(f => {
                        if (record && record[f.name] !== undefined) {
                            this.formData[f.name] = record[f.name];
                        } else if (f.defaultValue !== undefined) {
                            this.formData[f.name] = f.defaultValue;
                        } else {
                            this.formData[f.name] = (f.type === 'boolean') ? false : '';
                        }
                    });
                    
                    this.isModalOpen = true;
                },

                closeModal() {
                    this.isModalOpen = false;
                    this.formData = {};
                    this.editId = null;
                },

                async saveRecord() {
                    try {
                        const payload = { ...this.formData };
                        this.formFields.forEach(f => {
                            if (f.type === 'number') payload[f.name] = Number(payload[f.name]);
                            if (f.type === 'boolean') payload[f.name] = String(payload[f.name]) === 'true'; 
                        });

                        const url = this.editId 
                            ? `${this.API_BASE}/${this.currentObject.name}/${this.editId}` 
                            : `${this.API_BASE}/${this.currentObject.name}`;
                        
                        const method = this.editId ? 'PUT' : 'POST';
                        
                        const res = await fetch(url, { method, headers: this.HEADERS, body: JSON.stringify(payload) });

                        if (!res.ok) throw new Error(await res.text());
                        
                        this.closeModal();
                        this.loadData();
                    } catch (e) {
                        this.error = e.message;
                    }
                },

                async deleteRecord(id) {
                    if (!confirm("Are you sure?")) return;
                    try {
                        const res = await fetch(`${this.API_BASE}/${this.currentObject.name}/${id}`, {
                            method: 'DELETE',
                            headers: this.HEADERS
                        });
                        if (!res.ok) throw new Error(await res.text());
                        this.closeModal();
                        this.loadData();
                    } catch (e) {
                         this.error = e.message;
                    }
                }
            }
        }
    </script>
</body>
</html>
