# Multi-Level Approval Workflow with Delegation and Escalation
# This workflow demonstrates advanced approval features

name: "Purchase Order Approval"
description: "Multi-level approval workflow with delegation and escalation support"
type: approval
version: "1.0.0"

states:
  draft:
    initial: true
    transitions:
      submit:
        target: pending_manager
        guards:
          - has_required_fields
          - has_valid_amount
        actions:
          - validate_purchase_order
          - notify_manager
    metadata:
      label: "Draft"
      description: "Purchase order is being prepared"
  
  pending_manager:
    transitions:
      approve:
        target: pending_director
        actions:
          - record_manager_approval
          - notify_director
      reject:
        target: rejected
        actions:
          - record_manager_rejection
          - notify_requester_rejection
      delegate:
        target: pending_manager
        actions:
          - handle_delegation
    on_enter:
      - create_manager_approval_task
      - set_manager_deadline
    metadata:
      label: "Pending Manager Approval"
      description: "Waiting for manager to review"
      approvalLevel: 1
      escalationTarget: "senior_manager"
      escalationTimeout: 172800000  # 48 hours
  
  pending_director:
    transitions:
      approve:
        target: pending_cfo
        actions:
          - record_director_approval
          - notify_cfo
      reject:
        target: rejected
        actions:
          - record_director_rejection
          - notify_requester_rejection
      delegate:
        target: pending_director
        actions:
          - handle_delegation
    on_enter:
      - create_director_approval_task
      - set_director_deadline
    metadata:
      label: "Pending Director Approval"
      description: "Waiting for director to review"
      approvalLevel: 2
      escalationTarget: "vp_operations"
      escalationTimeout: 259200000  # 72 hours
  
  pending_cfo:
    transitions:
      approve:
        target: approved
        actions:
          - record_cfo_approval
          - notify_requester_approval
          - notify_procurement
          - send_slack_notification
      reject:
        target: rejected
        actions:
          - record_cfo_rejection
          - notify_requester_rejection
      delegate:
        target: pending_cfo
        actions:
          - handle_delegation
    on_enter:
      - create_cfo_approval_task
      - set_cfo_deadline
    metadata:
      label: "Pending CFO Approval"
      description: "Waiting for CFO final approval"
      approvalLevel: 3
      escalationTarget: "ceo"
      escalationTimeout: 345600000  # 96 hours
  
  approved:
    final: true
    on_enter:
      - set_approved_date
      - send_approval_notifications
      - trigger_procurement_process
    metadata:
      label: "Approved"
      description: "Purchase order has been fully approved"
  
  rejected:
    final: true
    on_enter:
      - set_rejected_date
      - send_rejection_notifications
      - archive_purchase_order
    metadata:
      label: "Rejected"
      description: "Purchase order was rejected"
